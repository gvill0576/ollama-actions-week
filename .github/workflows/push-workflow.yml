name: Push Workflow

on:
  push:
    branches:
      - main
      - feature/*

env:
  COURSE_NAME: "AI Cloud and DevOps Bootcamp"
  COHORT: "Echo"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify name.txt exists
        run: |
          if [ ! -f name.txt ]; then
            echo "ERROR: name.txt not found!"
            exit 1
          fi
          echo "✓ name.txt exists"
      
      - name: Verify devops.txt exists
        run: |
          if [ ! -f devops.txt ]; then
            echo "ERROR: devops.txt not found!"
            exit 1
          fi
          echo "✓ devops.txt exists"
  
  build:
    needs: setup
    runs-on: ubuntu-latest
    
    env:
      REPORT_TITLE: "Automated Workflow Summary"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Main branch only step
        if: github.ref == 'refs/heads/main'
        run: echo "✓ This step ONLY runs on main branch!"
      
      - name: Feature branch only step
        if: startsWith(github.ref, 'refs/heads/feature/')
        run: echo "✓ This step ONLY runs on feature branches!"
      
      - name: Cohort-specific step
        if: env.COHORT == 'Echo'
        run: echo "✓ Hello Echo cohort!"
      
      - name: Create log file
        id: create-log
        run: |
          echo "Workflow executed at: $(date)" > log.txt
          echo "This workflow was triggered by a push" >> log.txt
      
      - name: Print working directory
        run: pwd
      
      - name: Display log contents
        run: cat log.txt
      
      - name: Read name.txt
        run: |
          echo "=== My Name ==="
          cat name.txt
      
      - name: Read devops.txt
        run: |
          echo "=== Why I'm Learning DevOps ==="
          cat devops.txt
      
      - name: Generate summary report
        run: |
          echo "=== $REPORT_TITLE ===" > summary.txt
          echo "Generated at: $(date)" >> summary.txt
          echo "Course: $COURSE_NAME" >> summary.txt
          echo "Cohort: $COHORT" >> summary.txt
          echo "Triggered by: ${{ github.actor }}" >> summary.txt
          echo "Repository: ${{ github.repository }}" >> summary.txt
          echo "Branch: ${{ github.ref }}" >> summary.txt
          echo "" >> summary.txt
          echo "Name:" >> summary.txt
          cat name.txt >> summary.txt
          echo "" >> summary.txt
          echo "DevOps Motivation:" >> summary.txt
          cat devops.txt >> summary.txt
      
      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: summary-report
          path: summary.txt
      
      - name: Cleanup on failure
        if: failure()
        run: echo "⚠️ Something went wrong! Running cleanup..."
  
  report:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download summary artifact
        uses: actions/download-artifact@v4
        with:
          name: summary-report
      
      - name: Display final summary report
        run: |
          echo "=== FINAL REPORT ==="
          cat summary.txt
      
      - name: Print completion message
        if: success()
        run: echo "✓ Workflow completed successfully!"
